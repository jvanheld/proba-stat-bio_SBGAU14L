---
title: "Tuto et TP: tests de comparaison de moyenne"
subtitle: "Proba/stat pour la biologie (SBGAU14L)"
author: "Jacques van Helden (ORCID [0000-0002-8799-8584](https://orcid.org/0000-0002-8799-8584))"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    highlight: zenburn
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: 3
  ioslides_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_md: no
    smaller: yes
    theme: cerulean
    toc: yes
    widescreen: yes
  beamer_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_tex: no
    slide_level: 2
    theme: Montpellier
    toc: yes
  slidy_presentation:
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    incremental: no
    keep_md: no
    smaller: yes
    theme: cerulean
    toc: yes
    toc_float: yes
    widescreen: yes
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    toc: yes
    toc_depth: 3
---

```{r settings, include=FALSE, echo=FALSE, eval=TRUE}
library(knitr)

options(width = 300)
# options(encoding = 'UTF-8')
knitr::opts_chunk$set(
  fig.width = 7, fig.height = 5, 
  fig.path = 'figures/canale23_',
  fig.align = "center", 
  size = "tiny", 
  echo = TRUE, 
  eval = TRUE, 
  warning = FALSE, 
  message = FALSE, 
  results = TRUE, 
  comment = "")

options(scipen = 12) ## Max number of digits for non-scientific notation
# knitr::asis_output("\\footnotesize")

```


## But de ce TP

Le but de ce TP est de mettre en oeuvre un test $t$ de Student pour comparer les moyennes des niveaux d'abondance du protéome, entre deux types de tissus: 

- foie (*liver*)
- hépatocarinome cellulaire (*HCC*)

**Approche pédagogique : ** avant de présenter la théorie ou de procéder au test statistique à proprement parler, nous allons effectuer quelques analyses empiriques sur l'ensemble de nos données de protéome, pour acquérir une intuition de leur structuration : 

- moyennes d'échantillons de chaque protéine pour les deux tissus respectifs
- variances et écart-types d'échantillons pour chaque protéines
- relation entre moyennes et variances

## Téléchargement et chargement des données

Lors du TP précédent, nous avons téléchargé les données de Canale (2023) dans notre dossier de travail. 
Nous reprenons le même code pour nous assurer qu'elles se trouvent bien dans le dossier data, et que les tables de données ont les  dimensions attendues; 


### Downloading datasets from the github repository


```{r data_download}

## This  chunk of code below automatically performs the following operations
## 1. Define the working directory, check if it exists and if not create it
## 2. Define the data directory, check if it exists and if not create it
## 3. Download the proteomics data (quantification table) 
##    and metadata (protein names, sample groups) in the data directory. 
##    If the files are already present, the download is skipped. 

## Working dir 
working_dir <- "~/proba_stat_bio_TP/canale_2023"
dir.create(working_dir, recursive = TRUE, showWarnings = FALSE)
setwd(working_dir)
message("Working directory: ", working_dir)

#### Check data directory and create it if necessary ####
data_dir <- file.path(working_dir, "data")
dir.create(data_dir, recursive = TRUE, showWarnings = FALSE)
message("Data directory: ", data_dir)


## Define file names
files <- c("canale_2023_protein_log2-LFQ.tsv", 
           "canale_2023_protein-names.tsv", 
           "sample_groups.tsv")

## Download the data from github to the local data dir
repo_base <- "https://raw.githubusercontent.com/jvanheld/proba-stat-bio_SBGAU14L/refs/heads/main/data/canale_2023/"


for (f in files) {
  ## Define the destination path (data dir + file name)
  dest_file <- file.path(data_dir, f)
  
  ## Check if the file is already there, and if so skip, else download it
  if (file.exists(dest_file)) {
    message("File ", f, " already here, skipping the download")
  } else {
    source_url <- file.path(repo_base, f)
    message("Downloading file ", f, " from github")
    download.file(source_url, dest_file, quiet = FALSE)
  }
}

```


| | |
|-----------------------|----------------------------------------------------|
| Working directory: | `r working_dir` |
| Data directory: | `r data_dir` |
| Files present in the data directory | `r list.files(data_dir)` |

### Data loading


We will load 3 data files, that will be used at different stages of our analysis. 
These files are provided as text files, with columns separated by tabulations (the so-called "tab-separated values" format, with extension `.tsv`).

| File | Content |
|------------------------------|-------------------------------------------|
| `canale_2023_protein_log2-LFQ.tsv` | The proteomics quantification table, with one row per protein, and one column per sample. Note that the first column provides protein IDs, and the first row sample IDs |
| `canale_2023_protein-names.tsv` | One row per protein, and columns with the protein IDs, protein names and gene names. Note that a protein can have one or more IDs (allocated by different databases), and zero, one or more protein or gene names (some proteins/genes of unknown function have no name, ans some proteins/genes can have several synonyms). |
| `sample_groups.tsv` | A 3-columns tab-separated files containing one row per sample ID (first column, used as row names), and its decomposition in two fields indicating the group to which each sample belongs, and the patient ID (number). In this study case, there are only two groups : **HCC** for Human cancer cells, and **Liver** for liver cells.

```{r data_loading}
message("Loading the datasets")

#### Load the data file ####
log2_LFQ = read.delim(
  file = file.path(data_dir, "canale_2023_protein_log2-LFQ.tsv"), 
  sep="\t", 
  header=TRUE, 
  row.names=1)

## Load a separate table indicating which sample belongs to which group (cancer or liver cells)
sample_groups = read.delim(
  file.path(data_dir, "sample_groups.tsv"), 
  sep="\t", 
  header=TRUE, 
  row.names=1)

## Load the protein names from a separate table
protein_names = read.delim(file = file.path(data_dir, "canale_2023_protein-names.tsv"), sep = "\t")
```

The data and metadata files have been loaded in the following R variables. 

| Variable | Rows | Columns | Content | 
|-------------|-----|------|------------------------------------|
| `log2_LFQ` | `r nrow(log2_LFQ)` | `r ncol(log2_LFQ)` | Protein quantification table, in log2(LFQ), where LFQ stands for label-free quantification. One row per protein, one column per sample |
| `protein_names` | `r nrow(protein_names)` | `r ncol(protein_names)` | Protein identifiers, protein names and gene names. One row per protein |
| `sample_groups` | `r nrow(sample_groups)` | `r ncol(sample_groups)` | One row per sample, two columns inidicating its group and its patient identifier (number) |

In the table above, check carefully the consistency between the dimensions of the 3 tables : 

- `protein_names` should have the same number of rows as `log2_LFQ` (one row per protein)
- the number of rows of `sample_groups` (one row per sample) should equal the number of columns of `log2_LFQ` (one column per sample)


****************************************************************
## Moyennes d'échantillons par type de tissu

Lors du TP précédent, nous avons mesuré les statistiques marginales (moyenne, écart-type) pour chaque protéine, tous échantillons confondus. 
Nous allons maintenant calculer les mêmes statistiques en séparant les échantillons par type tissulaire : 

- *liver*: foie
- *HCC*: hépatocarcinome cellulaire

Pour cela nous allons utiliser la table de métadonnées `sample_groups`.

**Exercice : ** 
- Utilisez pour cela la fonction `subset()` pour sélectionner les noms d'échantillons correspondant aux deux types cellulaires. 
- A partir de la data.frame `log2_LFQ` qui contient les données protéomiques de tous les échantillons, créez deux data.frames nommées respectivement `log2_LFQ_liver` et  `logLFQHCC` avec le sous-ensemble de colonnes des tissus correspondants. 
- Calculez les moyennes marginales respectives des échantillons de foie et de cellules hépatocarcinome cellulaire, et stockez-les dans des vecteurs nommés respectivement `mean_per_protein_liver` et  `mean_per_protein_HCC`. 
- Dessinez un nuage de points (scatter plot) représentant la moyenne marginale des échantillons HCC (ordonnée) en fonction de la moyenne marginale des échantillons de foie (abscisse). Ajoutez une ligne (`abline()`) qui marque la médiane de ce graphique. 


**Astuces : **

- Pour vous faciliter la tâche, nous fournissons les étapes de sélection pour l'un des types tissulaires, nous vous laissons ajouter les commandes pour traiter le deuxième. 
- Utilisez la fonction R `densCols()` pour indiquer les régions où se superposent un grand nombre de points


```{r plot_meanper_group, fig.width=8, fig.height=8, out.width="90%", fig.cap="Sample means per tissue type. HCC: Hepatocarcinome cells. "}
## Select the sample labels for the two tissue types
liver_samples <- rownames(subset(sample_groups, group=="Liver"))
HCC_samples <- rownames(subset(sample_groups, group=="HCC"))

## Extract two subsets of the proteome abundance table, corresponding to the two tissue table
log2_LFQ_liver <- log2_LFQ[, liver_samples]
log2_LFQ_HCC <- log2_LFQ[, HCC_samples]
# dim(log2_LFQ_liver)
# dim(log2_LFQ_HCC)

## Compute marginal means per protein for each tissue type
mean_per_protein_liver <- apply(log2_LFQ_liver, 1, sum, na.rm=TRUE)
mean_per_protein_HCC <- apply(log2_LFQ_HCC, 1, sum, na.rm=TRUE)

## Scatter plot of the means per group
plot(mean_per_protein_liver, 
     mean_per_protein_HCC, 
     col=densCols(
       x = mean_per_protein_liver, 
       y = mean_per_protein_HCC),
     main = "Mean abundance per protein",
     xlab = "mean(log2_LFQ), liver", 
     ylab = "mean(log2_LFQ), HCC", 
     las=1)
grid() ## Add a grid
abline(a = 0, b = 1, col = "brown", lwd=2)

```



****************************************************************
## Formules mathématiques

- Les syboles grecs ($\mu$, $\sigma$) correspondent aux statistiques de population, les symboles romains ($\bar{x}$, $s$) aux statistiques d'échantillon.
- L'accent circonflexe ($\hat{ }$) indique les estimateurs de paramètres de population calculés à partir de paramètres d'échantillons. 

| Symboles et formules       | Description   |
|--------------|----------------------------------------------------|
| $\mu_{1},  \mu_{2}$ | Moyennes respectives des populations 1 et 2. |
| $\sigma_{1}, \sigma_{2}$ | Ecarts-types respectifs des populations 1 and 2. |
| $N_1$, $N_2$ | Tailles (nombre d'individus) des populations 1 et 2. |
| $n_1$, $n_2$ | Effectifs (nombre d'individus) des échantillons prélevés sur les populations 1 et 2. |
| $\bar{x}_{1}, \bar{x}_{2}$ | Moyennes d'échantillons. |
| $\delta = \mu_{2} - \mu{1}$ | Différence entre les moyennes des populations. |
| $d = \hat{\delta} = \hat{\mu}_2 - \hat{\mu}_1  = \bar{x}_2 - \bar{x}_1$ | $d$ = **Taille d'effet**: dans un test de comparaison de moyennes, il s'agit de la différence entre les moyennes d'échantillons, utilisée comme estimateur de $\delta$. |
| $s^2_{1}, s^2_{2}$ | Variances mesurées sur les échantillons. |
| $\hat{\sigma}_p = \sqrt{\frac{n_1 s_1^2 + n_2 s_2^2}{n_1+n_2-2}}$ | Ecart-type groupé (*pooled standard deviation*), utilisé comme estimateur de l'écart-type commun des deux populations, en supposant leurs variances égales (hypothèse de travail d'homoscédasticité). |
| $\hat{\sigma}_\delta = \hat{\sigma}_p \sqrt{\left(\frac{1}{n_1}+ \frac{1}{n_2}\right)}$  | Erreur standard sur la différence entre moyennes, en supposant que les populations ont la même variance (test de Student). |
| $t_{S} = \frac{\hat{\delta}}{\hat{\sigma}_\delta} =  \frac{\bar{x}_{2} - \bar{x}_{1}}{\sqrt{\frac{n_1 s_{1}^2 + n_2 s_{2}^2}{n_1+n_2-2} \left(\frac{1}{n_1}+ \frac{1}{n_2}\right)}}$ | statistique $t$ de Student |
| $t_{W}=\frac{\bar{x}_{1} - \bar{x}_{2}}{\sqrt{\frac {s^2_{1}}{n_1} + \frac{s^2_{2}}{n_2}}}$ | statistique $t$ de Welch |
| | |

